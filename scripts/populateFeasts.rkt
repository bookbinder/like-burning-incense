#!/usr/bin/racket
#lang racket

(require racket/date
         net/http-easy
         net/cookies
         net/url
         racket/class
         db)

(define pgc (postgresql-connect
             #:user "ryan"
             #:database "offices"
             #:password "art"
             ))

(define feasts
  '(
    ("0102_Basil_the_Great_and_Gregory_Nazianzen" 1 2 2025)
    ("0104_Elizabeth_Seton" 1 4 2025)
    ;; ("0105_John_Neumann")
        ;; ("0112_Baptism_of_the_Lord")
    ("0124_Francis_de_Sales" 1 24 2025)
    ("0125_The_Conversion_of_Paul" 1 25 2024)
    ("0126_Sts_Timothy_and_Titus" 1 26 2024)
    ("0128_Thomas_Aquinas" 1 28 2025)
    ("0131_Don_Bosco" 1 31 2023)
    ("0202_The_Presentation_in_the_Temple" 2 2 23)
    ("0205_St_Agatha" 2 5 2024)
    ("0206_Paul_Miki_and_Companions" 2 6 2023)
    ("0210_St_Scholastica" 2 10 2023)
    ("0214_Cyril_and_Methodius" 2 14 2025)
    ("0222_Chair_of_Peter" 2 22 2024)
    ;; ("0405_Vincent_Ferrer")
    ;; ("0407_John_Baptist_de_la_Salle")
    ;; ("0411_Stanislaus")
    ;; ("0413_Martin_I")
    ;; ("0421_Anselm_of_Canterbury")
    ;; ("0423_Adalbert")
    ;; ("0423_George")
    ;; ("0423_Giles")
    ;; ("0424_Fidelis_of_Sigmaringen")
    ;; ("0425_Mark")
    ;; ("0428_Louis_De_Montfort")
    ;; ("0428_Peter_Chanel")
    ("0429_Catherine_of_Siena" 4 29 25)
    ;; ("0430_James_the_Greater")
    ;; ("0430_Pius_V")
    ;; ("0501_Philip_and_James")
    ;; ("0501_St_Joseph_the_Worker")
    ("0502_Athanasius" 5 2 2025)
    ("0503_Philip_and_James" 5 3 2024)
    ;; ("0510_Damien_of_Molokai")
    ;; ("0510_John_of_Avila")
    ;; ("0511_Cyril_and_Methodius")
    ;; ("0512_Nereus_and_Achilleus")
    ;; ("0512_Pancras")
    ;; ("0513_Our_Lady_of_Fatima")
    ;; ("0514_Matthias" 5 13 2024)
    ;; ("0518_John_I")
    ;; ("0521_Christopher_Magallanes")
    ;; ("0522_Rita_of_Cascia")
    ;; ("0524_Jackson_Kemper")
    ;; ("0525_Bede_the_Venerable")
    ;; ("0525_Gregory_VII")
    ;; ("0525_Mary_Magdelene_de_Pazzi")
    ;; ("0526_Philip_Neri" 5 26 2025)
    ;; ("0527_Augustine_of_Canterbury")
    ;; ("0529_Pope_Paul_VI")
    ("0531_The_Visitation_of_Mary" 5 31 2024)
    ("0601_Justin_Martyr" 6 1 2023)
    ;; ("0602_Marcellinus_and_Peter")
    ;; ("0602_The_Martyrs_of_Lyons")
    ("0603_The_Martyrs_of_Uganda" 6 3 2024)
    ("0605_St_Boniface" 6 5 2025)
    ;; ("0606_St_Norbert")
    ;; ("0609_Ephrem_of_Edessa")
    ;; ("0609_St_Columba_of_Iona")
    ("0611_St_Barnabas" 6 11 2025)
    ("0613_Anthony_of_Padua" 6 13 2025)
    ;; ("0614_Basil_the_Great")
    ;; ("0615_Evelyn_Underhill")
    ;; ("0616_Joseph_Butler")
    ;; ("0618_Bernard_Mizeki")
    ;; ("0619_St_Romuald")
    ("0621_Aloysius_Gonzaga" 6 21 2025)
    ;; ("0622_John_Fisher_and_Thomas_More")
    ;; ("0622_St_Alban")
    ;; ("0622_St_Paulinus_of_Nola")
    ;; ("0627_Cyril_of_Alexandria")
    ("0628_Irenaeus" 6 28 2024)
    ;; ("0629_Peter_and_Paul")
    ;; ("0630_First_Martyrs_of_Rome")
    ;; ("0701_Junipero_Serra")
    ("0703_Thomas" 7 3 2025)
    ;; ("0705_Anthony_Mary_Zaccaria")
    ;; ("0705_Elizabeth_of_Portugal")
    ;; ("0706_Maria_Goretti")
    ;; ("0709_Augustine_Zhao_Rong_and_the_Chinese_Martyrs")
    ("0711_St_Benedict_of_Nursia" 7 11 2025)
    ;; ("0713_St_Henry_II")
    ("0714_Kateri_Tekakwitha" 7 14 2025)
    ("0715_St_Bonaventure" 7 15 2025)
    ;; ("0716_Our_Lady_of_Mt_Carmel")
    ;; ("0718_Camillus_de_Lellis")
    ;; ("0720_Apollinaris")
    ;; ("0721_Lawrence_of_Brindisi")
    ("0722_Mary_Magdalene" 7 22 2025)
    ;; ("0723_Bridget_of_Sweden")
    ;; ("0724_Sharbel_Makhluf")
    ("0725_James_the_Greater" 7 25 2025)
    ("0726_Ann_and_Joachim" 7 26 2024)
    ("0729_Sts_Martha,_Mary,_and_Lazarus" 7 29 2024)
    ;; ("0730_Peter_Chrysologus")
    ("0731_Ignatius_of_Loyola" 7 31 2024)
    ("0801_Alphonsus_Liguori" 8 1 2024)
    ;; ("0802_Eusebius_of_Vercelli")
    ;; ("0802_Peter_Julian_Eymard")
    ("0804_John_Vianney" 8 4 2023)
    ("0806_Transfiguration" 8 6 2024)
    ;; ("0807_Cajetan")
    ;; ("0807_Sixtus_II")
    ;; ("0808_Mary_MacKillop_of_the_Cross")
    ("0808_St_Dominic" 8 8 2024)
    ;; ("0809_Teresa_Benedicta_of_the_Cross")
    ("0810_St_Laurence" 8 10 2023)
    ("0811_St_Clare_of_Assisi" 8 11 2023)
    ;; ("0812_St_Jane_Frances_De_Chantal")
    ;; ("0813_Pontian_and_Hippolytus")
    ("0814_Maximilian_Kolbe" 8 14 2025)
    ;; ("0815_The_Assumption_of_Mary")
    ;; ("0816_Stephen_of_Hungary")
    ;; ("0819_St_John_Eudes")
    ("0820_Bernard_of_Clairvaux" 8 20 2025)
    ("0821_Pope_Pius_X" 8 21 2025)
    ("0822_Queenship_of_Mary" 8 22 2025)
    ;; ("0823_Rose_of_Lima")
    ("0824_Bartholomew" 8 24 2023)
    ;; ("0825_Joseph_Calasanz")
    ;; ("0825_Louis,_King_of_France")
    ("0827_St_Monica" 8 27 2024)
    ("0828_Augustine,_Bishop_of_Hippo" 8 28 2024)
    ("0829_Beheading_of_John_the_Baptist" 8 29 2023)
    ;; ("0831_Aidan,_Missionary_to_Northumbria")
    ("0903_Gregory_the_Great" 9 3 2024)
    ;; ("0905_Teresa_of_Calcutta")
    ("0908_The_Nativity_of_Mary" 9 8 2025)
    ("0909_Peter_Claver" 9 9 2025)
    ;; ("0912_Holy_Name_of_Mary")
    ("0913_St_John_Chrysostom" 9 13 2024)
    ("0914_Holy_Cross" 9 14 2023)
    ("0915_Our_Lady_of_Sorrows" 9 15 2023)
    ("0916_Cornelius_and_Cyprian" 9 16 2024)
    ;; ("0916_Ninian_of_Galloway")
    ;; ("0917_Robert_Bellarmine")
    ;; ("0917_St_Hildegard_of_Bingen")
    ;; ("0919_Januarius")
    ("0920_Andrew_Kim_Taegon_and_Paul_Chong_Hasang" 9 20 2024)
    ("0921_Matthew" 9 21 2023)
    ("0923_Pio_of_Pietrelcina" 9 23 2024)
    ;; ("0924_Thecla")
    ;; ("0925_St_Sergius_of_Rádonezh")
    ;; ("0926_Sts_Cosmas_and_Damian")
    ("0927_St_Vincent_de_Paul" 9 27 2024)
    ;; ("0928_St_Lawrence_Ruiz")
    ;; ("0928_St_Wenceslaus")
    ("0929_St_Michael_and_All_Angels" 9 29 2023)
    ("0930_St_Jerome" 9 30 2024)
    ;; ("1001_Protection_of_the_Mother_of_God")
    ;; ("1001_Remigius_of_Rheims")
    ("1001_Therese_of_Lisieux" 10 1 2024)
    ("1002_Guardian_Angels" 10 2 2024)
    ("1004_St_Francis_of_Assisi" 10 4 2024)
    ;; ("1005_Faustina_Kowalska")
    ;; ("1005_Francis_Xavier_Seelos")
    ;; ("1006_Marie-Rose_Durocher")
    ;; ("1006_St_Bruno")
    ;; ("1007_Our_Lady_of_the_Rosary" 10 7 2025)
    ;; ("1009_Denis_and_Companions")
    ;; ("1009_John_Leonardi")
    ;; ("1009_Robert_Grosseteste")
    ;; ("1011_Pope_John_XXIII")
    ;; ("1014_Callistus_I")
    ("1015_Teresa_of_Avila" 10 15 2025)
    ;; ("1016_Hedwig")
    ;; ("1016_Margaret_Mary_Alacoque")
    ("1017_Ignatius_of_Antioch" 10 17 2025)
    ("1018_Luke" 10 18 2024)
    ("1019_Isaac_Jogues_and_John_De_Brebeuf" 10 19 2023)
    ;; ("1020_Paul_of_the_Cross")
    ;; ("1022_John_Paul_II")
    ;; ("1023_John_of_Capistrano")
    ;; ("1024_Anthony_Claret")
    ("1028_Simon_and_Jude" 10 28 2024)
    ;; ("1101_All_Saints_Day")
    ("1102_All_Souls_Day" 11 2 2023)
    ;; ("1103_Martin_de_Porres")
    ("1104_Charles_Borromeo" 11 4 2024)
    ;; ("1107_Willibrord")
    ("1109_Dedication_of_Lateran" 11 9 2023)
    ("1110_Leo_The_Great" 11 10 2023)
    ("1111_Martin_of_Tours" 11 11 2024)
    ("1112_St_Josaphat_Kuncevyv" 11 12 2024)
    ("1113_St_Frances_Xavier_Cabrini" 11 13 2024)
    ;; ("1113_St_John_Chrysostom")
    ;; ("1115_St_Albert_the_Great")
    ;; ("1116_Gertrude_the_Great")
    ;; ("1116_Margaret_of_Scotland")
    ("1117_St_Elizabeth_of_Hungary" 11 17 2025)
    ;; ("1117_St_Hilda_of_Whitby")
    ;; ("1117_St_Hugh_of_Lincoln")
    ;; ("1118_Rose_Philippine_Duchesne")
    ;; ("1118_St_Hilda_of_Whitby")
    ;; ("1119_St_Elizabeth_of_Hungary")
    ("1121_Presentation_of_Mary" 11 21 2025)
    ("1122_St_Cecilia" 11 22 2024)
    ;; ("1123_Clement_of_Rome")
    ;; ("1123_Columban")
    ;; ("1123_Miguel_Agustín_Pro")
    ("1124_Andrew_Dung-Lac" 11 24 2023)
    ;; ("1125_Catherine_of_Alexandria")
    ("1130_Andrew_the_Apostle" 11 30 2023)
    ("1203_St_Francis_Xavier" 12 3 2025)
    ("1207_St_Ambrose" 12 7 2025)
    ("1212_Our_Lady_of_Guadalupe" 12 12 2025)
    ("1213_St_Lucy" 12 13 2025)
    ("1214_John_of_the_Cross" 12 14 2025)
    ;; ("1221_Thomas")
    ("1226_St_Stephen" 12 26 2025)
    ("1227_John_the_Apostle" 12 27 2025)
    ("1228_Holy_Innocents" 12 28 2025)
    ))

(define (next-day month day [year 2025])
  (let ([dt
         (seconds->date
          (+ (date->seconds (date 0 0 12 day month year 0 0 #f 0))
             (* 60 60 24)))])
    (list (date-month dt) (date-day dt) (date-year dt))))

(define (prev-day month day [year 2025])
  (let ([dt
         (seconds->date
          (- (date->seconds (date 0 0 12 day month year 0 0 #f 0))
             (* 60 60 24)))])
    (list (date-month dt) (date-day dt) (date-year dt))))


(for ([a feasts])
  (let*-values ([(feast mon day year)
                 (apply values (cons (first a) (map number->string (cdr a))))]
                [(prevmon prevday prevyear)
                 (apply values (map number->string (prev-day (string->number mon) (string->number day) (string->number year))))]
                [(jar)
                 (new list-cookie-jar%)]
                [(session-with-cookies)
                 (make-session #:cookie-jar jar)]
                [(titlepage)
                 "https://www.ibreviary.com/m2/breviario.php"]
                [(optionspage)
                 "https://www.ibreviary.com/m2/opzioni.php"]
                [(matinspage)
                 "https://www.ibreviary.com/m2/breviario.php?s=ufficio_delle_letture"]
                [(laudspage)
                 "https://www.ibreviary.com/m2/breviario.php?s=lodi"]
                [(daytimepage)
                 "https://www.ibreviary.com/m2/breviario.php?s=ora_media"]
                [(vesperspage)
                 "https://www.ibreviary.com/m2/breviario.php?s=vespri"]
                [(complinepage)
                 "https://www.ibreviary.com/m2/breviario.php?s=compieta"])

    
    (sleep 1)

    (parameterize ([current-session session-with-cookies])
      (post optionspage #:form `((lang . "en")
                                  (giorno . ,day)
                                  (mese . ,mon)
                                  (anno . ,year)))
      
      (for ([title '("Matins" "Lauds" "Daytime" "Vespers" "Compline")]
            [page (list matinspage laudspage daytimepage
                        vesperspage complinepage)])
        (when (null?
               (query-list
                pgc
                "select cur_contents from ibrev_html where cur_day = $1 and cur_office = $2"
                feast title))
          (display (format "Processing ~a1-~a\n" feast title))
          (query-exec
           pgc
           "insert into ibrev_html values ($1, $2, $3, $4)"
           "None" feast title (~a (response-body (get page)))))))
    
    ))




